<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>研究室と講義の R コード - 非線形モデル-I</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">非線形モデル-I</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">研究室と講義の R コード</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Main</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">研究室と講義の R コード</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">基本編</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./part01.html" class="sidebar-item-text sidebar-link">R の基本操作</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./part02.html" class="sidebar-item-text sidebar-link">R 関数の基本</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./part03.html" class="sidebar-item-text sidebar-link">Tidyverse</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./part04.html" class="sidebar-item-text sidebar-link">データの操作</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">作図</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./part05.html" class="sidebar-item-text sidebar-link">ggplot の図</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">基礎統計学</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary-statistics.html" class="sidebar-item-text sidebar-link">記述統計</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ttest.html" class="sidebar-item-text sidebar-link">2群の比較：t 検定</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anova.html" class="sidebar-item-text sidebar-link">一元配置分散分析</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anova2.html" class="sidebar-item-text sidebar-link">多数群の比較：二元配置分散分析</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glm.html" class="sidebar-item-text sidebar-link">線形モデル</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonlinear.html" class="sidebar-item-text sidebar-link active">非線形モデル-I</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">その他</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./maps.html" class="sidebar-item-text sidebar-link">地図の作り方</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./japan-zenkoku.html" class="sidebar-item-text sidebar-link">全国の地図</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./windfetch.html" class="sidebar-item-text sidebar-link">送風距離の求め方</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#必要なパッケージ" id="toc-必要なパッケージ" class="nav-link active" data-scroll-target="#必要なパッケージ">必要なパッケージ</a></li>
  <li><a href="#データの読み込み" id="toc-データの読み込み" class="nav-link" data-scroll-target="#データの読み込み">データの読み込み</a>
  <ul class="collapse">
  <li><a href="#光環境データの処理" id="toc-光環境データの処理" class="nav-link" data-scroll-target="#光環境データの処理">光環境データの処理</a></li>
  <li><a href="#全データを結合" id="toc-全データを結合" class="nav-link" data-scroll-target="#全データを結合">全データを結合</a></li>
  <li><a href="#光合成速度を求める" id="toc-光合成速度を求める" class="nav-link" data-scroll-target="#光合成速度を求める">光合成速度を求める</a></li>
  </ul></li>
  <li><a href="#モデルの当てはめ" id="toc-モデルの当てはめ" class="nav-link" data-scroll-target="#モデルの当てはめ">モデルの当てはめ</a></li>
  <li><a href="#診断図" id="toc-診断図" class="nav-link" data-scroll-target="#診断図">診断図</a></li>
  <li><a href="#パラメータの集計" id="toc-パラメータの集計" class="nav-link" data-scroll-target="#パラメータの集計">パラメータの集計</a>
  <ul class="collapse">
  <li><a href="#モデル係数表について" id="toc-モデル係数表について" class="nav-link" data-scroll-target="#モデル係数表について">モデル係数表について</a></li>
  </ul></li>
  <li><a href="#多重比較" id="toc-多重比較" class="nav-link" data-scroll-target="#多重比較">多重比較</a></li>
  <li><a href="#モデル係数の相関関係" id="toc-モデル係数の相関関係" class="nav-link" data-scroll-target="#モデル係数の相関関係">モデル係数の相関関係</a></li>
  <li><a href="#ガウス誤差伝播法" id="toc-ガウス誤差伝播法" class="nav-link" data-scroll-target="#ガウス誤差伝播法">ガウス誤差伝播法</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">非線形モデル-I</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>ここで紹介する非線形モデルは、海洋生物科学実験III用に準備しました。 光合成光曲線の解析を紹介します。</p>
<section id="必要なパッケージ" class="level2">
<h2 class="anchored" data-anchor-id="必要なパッケージ">必要なパッケージ</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
✔ ggplot2 3.3.6      ✔ purrr   0.3.4 
✔ tibble  3.1.8      ✔ dplyr   1.0.10
✔ tidyr   1.2.0      ✔ stringr 1.4.0 
✔ readr   2.1.2      ✔ forcats 0.5.1 
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(googlesheets4)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggcorrplot)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(minpack.lm)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlstools)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
'nlstools' has been loaded.

IMPORTANT NOTICE: Most nonlinear regression models and data set examples
related to predictive microbiolgy have been moved to the package 'nlsMicrobio'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="データの読み込み" class="level2">
<h2 class="anchored" data-anchor-id="データの読み込み">データの読み込み</h2>
<p>データは Google Drive に共有しています。 <code>googlesheets4</code> のパッケージをつかて、データをクラウドからダウンロードできます。 リンクをクリックしたら、ブラウザからもダウンロードできます。 データは共有制限なしで公開したので、authentication なしでアクセスできます。 このときは <code>gs4_deauth()</code> を実行します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gs4_deauth</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Google Drive で共有したデータは次のURLの通りです。 リンクは実験日１〜３の google sheets に飛びます。</p>
<ul>
<li><a href="https://docs.google.com/spreadsheets/d/1CsY7ILKZRFlwQEIzSgu1veMQ964IPVegIJOo04lIGVE/edit#gid=1846404397">実験日 1</a></li>
<li><a href="https://docs.google.com/spreadsheets/d/1yeC-rJdxdiVa_icoNHZ1xrt4HWHyGCeQMnUt1r2_hnk/edit#gid=540001236">実験日 2</a></li>
<li><a href="https://docs.google.com/spreadsheets/d/1Im8Qg-ukk8uh_3z4H6IwirTc4nhxPqKrDWrjhK4gZ0o/edit#gid=2099964525">実験日 3</a></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>spreadsheet1 <span class="ot">=</span> <span class="st">"https://docs.google.com/spreadsheets/d/1CsY7ILKZRFlwQEIzSgu1veMQ964IPVegIJOo04lIGVE/edit#gid=1846404397"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>spreadsheet2 <span class="ot">=</span> <span class="st">"https://docs.google.com/spreadsheets/d/1yeC-rJdxdiVa_icoNHZ1xrt4HWHyGCeQMnUt1r2_hnk/edit#gid=540001236"</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>spreadsheet3 <span class="ot">=</span> <span class="st">"https://docs.google.com/spreadsheets/d/1Im8Qg-ukk8uh_3z4H6IwirTc4nhxPqKrDWrjhK4gZ0o/edit#gid=2099964525"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>公開した google sheets にはつぎのスプレッドシートが入っています。</p>
<ul>
<li>光合成データ</li>
<li>海藻資料データ</li>
<li>光環境データ</li>
</ul>
<p>データの読み込みは <code>read_sheet()</code> で行います。 各シートの構造は同じにしたので、<code>map()</code> をつかって一度にデータを読み込みます。 <code>fnames</code> 変数は解析に使わないので、<code>select(-fnames)</code> で外します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>mgldata <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">fnames =</span> <span class="fu">c</span>(spreadsheet1, spreadsheet2, spreadsheet3), <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(fnames, read_sheet, <span class="at">sheet =</span> <span class="st">"光合成データ"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fnames)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_1_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''光合成データ''.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_2_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''光合成データ''.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_3_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''光合成データ''.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>seaweed <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">fnames =</span> <span class="fu">c</span>(spreadsheet1, spreadsheet2, spreadsheet3), <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(fnames, read_sheet, <span class="at">sheet =</span> <span class="st">"海藻資料データ"</span>))<span class="sc">|&gt;</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fnames)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_1_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''海藻資料データ''.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_2_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''海藻資料データ''.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_3_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''海藻資料データ''.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>lightdata <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">fnames =</span> <span class="fu">c</span>(spreadsheet1, spreadsheet2, spreadsheet3), <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(fnames, read_sheet, <span class="at">sheet =</span> <span class="st">"光環境データ"</span>))<span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fnames)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_1_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''光環境データ''.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_2_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''光環境データ''.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Reading from "Photosynthesis_Lab_Day_3_2018".</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Range ''光環境データ''.</code></pre>
</div>
</div>
<section id="光環境データの処理" class="level3">
<h3 class="anchored" data-anchor-id="光環境データの処理">光環境データの処理</h3>
<p>光条件毎の (<code>light</code>) 光量子量 (<code>ppfd</code>) の平均値を求めます。 <code>アルミホイル</code> の光条件のときの光量子量は測っていないが、<code>ppfd</code> は 0 とします。 <code>アルミホイル</code> のときのデータはコードとして定義して、追加します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>lightdata <span class="ot">=</span> lightdata <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">han =</span> <span class="st">"班"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">light =</span> <span class="st">"光環境"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">sample =</span> <span class="fu">matches</span>(<span class="st">"サンプル"</span>),</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">ppfd =</span> <span class="fu">matches</span>(<span class="st">"光量子"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(day, light) <span class="sc">|&gt;</span> </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ppfd =</span> <span class="fu">mean</span>(ppfd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'day'. You can override using the `.groups`
argument.</code></pre>
</div>
</div>
<p>アルミホイルのデータを定義し、<code>tmp</code> に入れます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">light =</span> <span class="fu">rep</span>(<span class="st">"アルミホイル"</span>,<span class="dv">3</span>), </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">ppfd =</span>  <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>観測したデータと <code>tmp</code> を縦に結合します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>lightdata <span class="ot">=</span> <span class="fu">bind_rows</span>(lightdata, tmp) <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">light =</span> <span class="fu">factor</span>(light), <span class="at">day =</span> <span class="fu">factor</span>(day))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="全データを結合" class="level3">
<h3 class="anchored" data-anchor-id="全データを結合">全データを結合</h3>
<p>光合成データ <code>mgldata</code> と海藻資料データ <code>seaweed</code> を結合します。 <code>matches()</code> は <code>select()</code> の <em>selection helper function</em> です。 <code>matches()</code> にわたした正規表現 (regular expression) とマッチ (match) した変数（列名）が返ってきます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mgldata <span class="ot">=</span> mgldata <span class="sc">|&gt;</span> <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">han =</span> <span class="st">"班"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">sample =</span> <span class="fu">matches</span>(<span class="st">"サンプル"</span>),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">min =</span> <span class="fu">matches</span>(<span class="st">"時間"</span>),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">mgl =</span> <span class="fu">matches</span>(<span class="st">"酸素"</span>),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">temperature =</span> <span class="fu">matches</span>(<span class="st">"水温"</span>),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">light =</span> <span class="fu">matches</span>(<span class="st">"光環境"</span>),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">seaweed =</span> <span class="fu">matches</span>(<span class="st">"海藻"</span>))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>seaweed <span class="ot">=</span> seaweed <span class="sc">|&gt;</span> <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">seaweed =</span> <span class="fu">matches</span>(<span class="st">"海藻"</span>),</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">han =</span> <span class="st">"班"</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">sample =</span> <span class="fu">matches</span>(<span class="st">"サンプル"</span>),</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">vol =</span> <span class="fu">matches</span>(<span class="st">"容量"</span>),</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">gww =</span> <span class="fu">matches</span>(<span class="st">"湿重量"</span>))</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>mgldata <span class="ot">=</span> <span class="fu">full_join</span>(mgldata, seaweed, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"han"</span>, <span class="st">"sample"</span>, <span class="st">"day"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>han</code>, <code>sample</code>, <code>day</code> は <code>as.factor()</code> を通して因子に変換します。 <code>across()</code> は複数変数に同じ関数を適応したいときにつかいます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>mgldata <span class="ot">=</span> mgldata <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(han, sample, day), as.factor))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>across()</code> を使わずに変換するなら、次通りです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mgldata <span class="ot">=</span> mgldata <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">han =</span> <span class="fu">as.factor</span>(han), <span class="at">sample =</span> <span class="fu">as.factor</span>(sample), <span class="at">day =</span> <span class="fu">as.factor</span>(day))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>結合したら，溶存酸素濃度の時間変動を可視化します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mgldata) <span class="sc">+</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> min, <span class="at">y =</span> mgl, <span class="at">color =</span> han)) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(light),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">cols =</span> <span class="fu">vars</span>(seaweed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>光の調整は編み袋 (ネット) でやっています。 ネットの枚数が増えると光量子量が下がります。 アルミホイルで光量子量が 0 の条件を作っています。 ネットがないとき (最も明るいとき) 溶存酸素濃度が顕著に増加しましたが、アルミホイルのときは緩やかに減少しました。</p>
</section>
<section id="光合成速度を求める" class="level3">
<h3 class="anchored" data-anchor-id="光合成速度を求める">光合成速度を求める</h3>
<p>複数データ群から光合成速度を計算したいので、<code>map()</code> 関数を通して行います。 <code>map()</code> に渡す光合成速度用関数を定義します。 <code>fit_model()</code> は線形モデルを溶存酸素濃度時系列データに当てはめ用です。 <code>get_rate()</code> は 2 つのモデル係数 <span class="math inline">(y = b_0+ b_1 x)</span> から傾き <span class="math inline">(b_1)</span> を抽出します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fit_model <span class="ot">=</span> <span class="cf">function</span>(df) {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(mgl <span class="sc">~</span> min, <span class="at">data =</span> df)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>get_rate <span class="ot">=</span> <span class="cf">function</span>(m) {</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coefficients</span>(m)[<span class="dv">2</span>] </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ここでデータをグループ化して、グループ毎の傾きを求めます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>mgldata <span class="ot">=</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  mgldata <span class="sc">|&gt;</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_nest</span>(day, han, sample, light, gww, vol, seaweed) <span class="sc">|&gt;</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, fit_model)) <span class="sc">|&gt;</span> </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">map_dbl</span>(model, get_rate)) <span class="sc">|&gt;</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stats =</span> <span class="fu">map</span>(model, glance)) <span class="sc">|&gt;</span> </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(stats) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>求めた係数と環境データを結合します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>alldata <span class="ot">=</span> <span class="fu">full_join</span>(mgldata, lightdata, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"day"</span>, <span class="st">"light"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>係数は湿重量を実験容器の容積で割って、湿重量あたりの純光合成速度を求めます。 ここで、係数の単位は mg O<sub>2</sub> l<sup>-1</sup> min<sup>-1</sup> から mg O<sub>2</sub> g<sub>ww</sub><sup>{-1}min</sup>-1^ に変わります。</p>
<p>単位の求め方：</p>
<p><span class="math display">
\overbrace{\frac{mg\;\text{O}_2}{l}}^{\text{酸素濃度}} \times \underbrace{\frac{1}{g_{ww}}}_{\text{湿重量}} \times \overbrace{ml}^{\text{容積}} \times \frac{1 \;l}{1000\; ml} \times \frac{1000\;\mu g\;\text{O}_2}{1\;mg\;\text{O}_2}
</span> R コード：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>alldata <span class="ot">=</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  alldata <span class="sc">|&gt;</span> </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">normalized_rate =</span> rate <span class="sc">/</span> gww <span class="sc">*</span> vol)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>解析をする前に、光量子量、種、班ごとの平均値を求めます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  alldata <span class="sc">|&gt;</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ppfd, seaweed, han) <span class="sc">|&gt;</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">np =</span> <span class="fu">mean</span>(normalized_rate))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'ppfd', 'seaweed'. You can override using
the `.groups` argument.</code></pre>
</div>
</div>
<p>標準化した光合成速度は次の通りです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>xlabel <span class="ot">=</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"PPFD"</span><span class="sc">~</span>(mu<span class="sc">*</span>mol<span class="sc">~</span>m<span class="sc">^</span>{<span class="sc">-</span><span class="dv">2</span>}<span class="sc">~</span>s<span class="sc">^</span>{<span class="sc">-</span><span class="dv">1</span>})))</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>ylabel <span class="ot">=</span> <span class="st">'"Net photosynthesis rate"~(mu*g~O[2]~g[ww]^{-1}~min^{-1})'</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>ylabel <span class="ot">=</span> <span class="fu">as.expression</span>(<span class="fu">parse</span>(<span class="at">text =</span> ylabel))</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="sc">|&gt;</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> ppfd, <span class="at">y =</span> np, <span class="at">color =</span> han)) <span class="sc">+</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="st">""</span>, <span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(xlabel) <span class="sc">+</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(ylabel) <span class="sc">+</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="at">col =</span> <span class="fu">vars</span>(seaweed)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">ウミトラノオ、コブクロモク、ホンダワラ属海藻の幼体の光合成速度。記号の色はそれぞれの班を示しています。光合成速度のばらつきは光量子量があると大きくなるのが明らかです。</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="モデルの当てはめ" class="level2">
<h2 class="anchored" data-anchor-id="モデルの当てはめ">モデルの当てはめ</h2>
<p>非線形モデルの当てはめに便利な <code>nlstools</code> パッケージを使います。 当てはめたいモデルは次のとおりです。</p>
<p><span class="math display">
\overbrace{P_{net}}^{\text{純光合成速度}} = \underbrace{P_{max}\left(1 - \exp\left(-\frac{\alpha}{P_{max}}I\right)\right)}_{\text{総光合成速度}} - \overbrace{R_d}^{\text{暗呼吸速度}}
</span></p>
<ul>
<li><span class="math inline">P_{net}</span> は純光合成速度 (<code>normalized_rate</code>)</li>
<li><span class="math inline">I</span> は光量子量 (<code>ppfd</code>)</li>
<li><span class="math inline">P_{max}</span> は光合成飽和速度 (<code>pmax</code>)</li>
<li><span class="math inline">\alpha</span> は初期勾配 (<code>alpha</code>)</li>
<li><span class="math inline">R_d</span> は暗呼吸速度 (<code>rd</code>)</li>
</ul>
<p>このモデルをR関数に書き換えると次のようになります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>pecurve <span class="ot">=</span> <span class="cf">function</span>(ppfd, pmax, rd, alpha) {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  pmax <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>alpha <span class="sc">/</span> pmax <span class="sc">*</span> ppfd)) <span class="sc">-</span> rd</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>nlstools</code> の <code>preview()</code> 関数をつかって，モデル当てはめ用の関数 (<code>nls()</code>) に必要なの初期値を探します。 <code>variable</code> 引数に <code>ppfd</code> 変数の位置情報を渡してください。 この位置情報は <code>tibble</code> 変数（列）の順位です。 このデータの場合、<code>ppfd</code> は 1 列目なので、<code>variable = 1</code> を <code>preview()</code> に渡しています。 <code>str_detect()</code> も <code>matches()</code> と同じように正規表現をつかって、 <code>seaweed</code> 変数からマッチしたものを返します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>START <span class="ot">=</span> <span class="fu">list</span>(<span class="at">pmax =</span> <span class="dv">10</span>, <span class="at">rd =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>crispifolium <span class="ot">=</span> dataset <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(seaweed, <span class="st">"コブクロ"</span>))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>thunbergii   <span class="ot">=</span> dataset <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(seaweed, <span class="st">"ウミトラノオ"</span>))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>juvenile     <span class="ot">=</span> dataset <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(seaweed, <span class="st">"幼体"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">preview</span>(np <span class="sc">~</span> <span class="fu">pecurve</span>(ppfd, pmax, rd, alpha), </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> crispifolium, </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> <span class="dv">1</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> START)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
RSS:  167 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">preview</span>(np <span class="sc">~</span> <span class="fu">pecurve</span>(ppfd, pmax, rd, alpha), </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> thunbergii, </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> <span class="dv">1</span>,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> START)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
RSS:  501 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">preview</span>(np <span class="sc">~</span> <span class="fu">pecurve</span>(ppfd, pmax, rd, alpha), </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> juvenile, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">variable =</span> <span class="dv">1</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> START)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
RSS:  246 </code></pre>
</div>
</div>
<p><code>+</code> 記号がデータの中心に通る用になったら，そのときの初期値を <code>nls()</code> または、<code>minpack.lm</code> パッケージの <code>nlsLM()</code> 関数に渡してモデルの当てはめをします。 <code>nls()</code> 関数は Gauss-Newton アルゴリズムによってパラメータ推定をしますが、<code>nlsLM()</code> は Levenberg-Marquardt アルゴリズムを用います。 Levenberg-Marquardt法のほうが優秀ですが、モデルの組み方によって使えないときがあります。</p>
<p>ここではデータを海藻毎に当てはめるので、解析関数をつくります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fit_nls <span class="ot">=</span> <span class="cf">function</span>(df) {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  START <span class="ot">=</span> <span class="fu">list</span>(<span class="at">pmax =</span> <span class="dv">14</span>, <span class="at">rd =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># nls(np ~ pecurve(ppfd, pmax, rd, alpha),  data = df, start = START)</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlsLM</span>(np <span class="sc">~</span> <span class="fu">pecurve</span>(ppfd, pmax, rd, alpha),  <span class="at">data =</span> df, <span class="at">start =</span> START)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> dataset <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_nest</span>(seaweed) <span class="sc">|&gt;</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, fit_nls))</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  seaweed                    data model 
  &lt;chr&gt;        &lt;list&lt;tibble[,3]&gt;&gt; &lt;list&gt;
1 ウミトラノオ           [24 × 3] &lt;nls&gt; 
2 コブクロモク           [24 × 3] &lt;nls&gt; 
3 幼体                   [24 × 3] &lt;nls&gt; </code></pre>
</div>
</div>
<p>当てはめたモデルの結果は次の通りです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> dataset <span class="sc">|&gt;</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">summary =</span><span class="fu">map</span>(model, glance)) <span class="sc">|&gt;</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(summary)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 12
  seaweed     data model sigma isConv  finTol logLik   AIC   BIC devia…¹ df.re…²
  &lt;chr&gt;   &lt;list&lt;t&gt; &lt;lis&gt; &lt;dbl&gt; &lt;lgl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;int&gt;
1 ウミト… [24 × 3] &lt;nls&gt;  2.51 TRUE   1.49e-8  -54.5 117.  122.    132.       21
2 コブク… [24 × 3] &lt;nls&gt;  2.21 TRUE   1.49e-8  -51.5 111.  116.    103.       21
3 幼体    [24 × 3] &lt;nls&gt;  1.31 TRUE   1.49e-8  -39.0  86.0  90.7    36.2      21
# … with 1 more variable: nobs &lt;int&gt;, and abbreviated variable names ¹​deviance,
#   ²​df.residual</code></pre>
</div>
</div>
<p>次はモデルの期待値を求めます。 この関数は期待値を擬似データから計算します。 擬似データは <code>tibble()</code> で作っています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>calc_fitted <span class="ot">=</span> <span class="cf">function</span>(data, model) {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="dv">21</span> <span class="co"># 擬似データの長さ</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  ndata <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">ppfd =</span> <span class="fu">seq</span>(<span class="fu">min</span>(data<span class="sc">$</span>ppfd), <span class="fu">max</span>(data<span class="sc">$</span>ppfd),<span class="at">length =</span> N))</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> ndata) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ndata,tmp)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> dataset <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">map2</span>(data, model, calc_fitted))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> ppfd, <span class="at">y =</span> np), <span class="at">data =</span> <span class="fu">unnest</span>(dataset, data))<span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> ppfd, <span class="at">y =</span> value), <span class="at">data =</span> <span class="fu">unnest</span>(dataset, fitted)) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(seaweed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">観測とモデル期待値。</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="診断図" class="level2">
<h2 class="anchored" data-anchor-id="診断図">診断図</h2>
<p>線形モデルと同様に、モデルを当てはめたら、残渣の診断図も確認します。 ここでは残渣 (residuals) とモデル期待値 (fitted) を求めます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>shindan <span class="ot">=</span> dataset <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seaweed, data, model) <span class="sc">|&gt;</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residuals =</span> <span class="fu">map</span>(model, residuals)) <span class="sc">|&gt;</span> </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">map</span>(model, fitted)) <span class="sc">|&gt;</span> </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seaweed, data, residuals, fitted) <span class="sc">|&gt;</span> </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="fu">everything</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> <span class="fu">ggplot</span>(shindan) <span class="sc">+</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> fitted, <span class="at">y =</span> residuals,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> seaweed),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">end =</span> <span class="fl">0.8</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> <span class="fu">ggplot</span>(shindan) <span class="sc">+</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> fitted, <span class="at">y =</span> <span class="fu">sqrt</span>(<span class="fu">abs</span>(residuals)),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> seaweed),</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">end =</span> <span class="fl">0.8</span>)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>p1<span class="sc">+</span>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">モデル残渣と残渣の絶対値の平方根の図で、モデルの当てはめの良さが分かります。（左）はモデル残渣対期待値です。期待値が増加するとモデル残渣の散らばりが大きくなるのがはっきりしています。点線 (0) の周りを均一にばらつくのが理想です。（右）は残渣の絶対値の平方根です。期待値が上がると残渣が増加しています。これらの図を確認すると、残渣のばらつきの均一性に問題があります。</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="パラメータの集計" class="level2">
<h2 class="anchored" data-anchor-id="パラメータの集計">パラメータの集計</h2>
<p>残渣プロットの結果はひどかったが、とりあえず、光飽和点 <span class="math inline">(I_k)</span> と光補償点 <span class="math inline">(I_c)</span> を求めましょう。</p>
<ul>
<li>光飽和点：<span class="math inline">I_k = P_{max} / \alpha</span></li>
<li>光補償点：<span class="math inline">I_c = \frac{P_{max}}{\alpha} \ln\left(\frac{P_{max}}{P_{max} - R_d}\right)</span></li>
</ul>
<p>まずは係数を抽出するための関数を定義します。 モデルの定義によって、<code>cfs</code> からパラメータを抽出すろときのコードが変わります。 <code>pecurve()</code> を定義したときに、<code>pmax</code>, <code>alpha</code>, <code>rd</code> がパラメータ名だったので、 抽出には <code>"pmax"</code>, <code>"alpha"</code>, <code>"rd"</code> の文字列を使いました。 文字列はパラメータ名と一致するようにしましょう。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>get_cfs <span class="ot">=</span> <span class="cf">function</span>(m) {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  cfs <span class="ot">=</span> <span class="fu">coef</span>(m)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">pmax =</span> cfs[<span class="st">"pmax"</span>],</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">alpha =</span> cfs[<span class="st">"alpha"</span>],</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">rd =</span> cfs[<span class="st">"rd"</span>])</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ここで光飽和点と光補償点を求めるための関数を定義します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>calc_ik <span class="ot">=</span> <span class="cf">function</span>(m) {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 光飽和点</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  cfs <span class="ot">=</span> <span class="fu">coef</span>(m)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  cfs[<span class="st">"pmax"</span>] <span class="sc">/</span> cfs[<span class="st">"alpha"</span>]<span class="sc">*</span><span class="fu">log</span>(cfs[<span class="st">"pmax"</span>]<span class="sc">/</span>(cfs[<span class="st">"pmax"</span>] <span class="sc">-</span> cfs[<span class="st">"rd"</span>]))</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>calc_ic <span class="ot">=</span> <span class="cf">function</span>(m) {</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 光補償点</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  cfs <span class="ot">=</span> <span class="fu">coef</span>(m)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  cfs[<span class="st">"pmax"</span>] <span class="sc">/</span> cfs[<span class="st">"alpha"</span>]</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>map()</code> を使って係数を求めます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>modelcfs <span class="ot">=</span> dataset <span class="sc">|&gt;</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seaweed, model) <span class="sc">|&gt;</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cfs =</span> <span class="fu">map</span>(model, get_cfs)) <span class="sc">|&gt;</span> </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ik =</span> <span class="fu">map</span>(model, calc_ik)) <span class="sc">|&gt;</span> </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ic =</span> <span class="fu">map</span>(model, calc_ic)) <span class="sc">|&gt;</span> </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(ik, ic, cfs))</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>modelcfs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
  seaweed      model   pmax  alpha    rd    ik    ic
  &lt;chr&gt;        &lt;list&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 ウミトラノオ &lt;nls&gt;  23.3  0.0858 2.08  25.4  271. 
2 コブクロモク &lt;nls&gt;   5.24 0.165  0.431  2.74  31.8
3 幼体         &lt;nls&gt;   4.50 0.0718 0.827 12.7   62.7</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">

<table>
 <thead>
  <tr>
   <th style="text-align:left;"> 海藻類 </th>
   <th style="text-align:right;"> P~max~ </th>
   <th style="text-align:right;"> α </th>
   <th style="text-align:right;"> R~d~ </th>
   <th style="text-align:right;"> I~k~ </th>
   <th style="text-align:right;"> I~c~ </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ウミトラノオ </td>
   <td style="text-align:right;"> 23.3 </td>
   <td style="text-align:right;"> 0.086 </td>
   <td style="text-align:right;"> 2.1 </td>
   <td style="text-align:right;"> 25.4 </td>
   <td style="text-align:right;"> 271.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> コブクロモク </td>
   <td style="text-align:right;"> 5.2 </td>
   <td style="text-align:right;"> 0.165 </td>
   <td style="text-align:right;"> 0.4 </td>
   <td style="text-align:right;"> 2.7 </td>
   <td style="text-align:right;"> 31.8 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 幼体 </td>
   <td style="text-align:right;"> 4.5 </td>
   <td style="text-align:right;"> 0.072 </td>
   <td style="text-align:right;"> 0.8 </td>
   <td style="text-align:right;"> 12.7 </td>
   <td style="text-align:right;"> 62.7 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<section id="モデル係数表について" class="level3">
<h3 class="anchored" data-anchor-id="モデル係数表について">モデル係数表について</h3>
<p>モデル係数の統計量は <code>summary()</code> または <code>nlstools</code> の <code>overview()</code> で見れます。 <code>Estimate</code> はモデル係数の期待値です。 <code>Std. Error</code> は係数の標準誤差です。 <code>t value</code> と <code>Pr(&gt;|t|)</code> は 0 に対して、モデル係数の t 値と t 値の P 値です。 この係数結果に出力されたものが Wald’s test の結果です。 すべての海藻類に対して、<span class="math inline">P_{max} = 0</span> の帰無仮説を棄却できますが、 <span class="math inline">R_d = 0</span> の帰無仮説は棄却できません。 コブクロモクと幼体の <span class="math inline">\alpha = 0</span> の帰無仮説は棄却できないが、ウミトラノオの場合は棄却できました。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="sc">|&gt;</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">summary =</span> <span class="fu">map</span>(model, summary)) <span class="sc">|&gt;</span> </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(summary, <span class="at">name =</span> seaweed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$ウミトラノオ

Formula: np ~ pecurve(ppfd, pmax, rd, alpha)

Parameters:
      Estimate Std. Error t value Pr(&gt;|t|)    
pmax  23.28655    5.72475   4.068 0.000553 ***
rd     2.07666    1.27193   1.633 0.117440    
alpha  0.08580    0.02415   3.553 0.001883 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.506 on 21 degrees of freedom

Number of iterations to convergence: 9 
Achieved convergence tolerance: 1.49e-08


$コブクロモク

Formula: np ~ pecurve(ppfd, pmax, rd, alpha)

Parameters:
      Estimate Std. Error t value Pr(&gt;|t|)   
pmax    5.2410     1.3996   3.745  0.00119 **
rd      0.4315     1.2211   0.353  0.72736   
alpha   0.1646     0.1069   1.539  0.13862   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.212 on 21 degrees of freedom

Number of iterations to convergence: 7 
Achieved convergence tolerance: 1.49e-08


$幼体

Formula: np ~ pecurve(ppfd, pmax, rd, alpha)

Parameters:
      Estimate Std. Error t value Pr(&gt;|t|)    
pmax   4.50104    0.92297   4.877 8.02e-05 ***
rd     0.82731    0.69152   1.196   0.2449    
alpha  0.07176    0.03480   2.062   0.0518 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.314 on 21 degrees of freedom

Number of iterations to convergence: 10 
Achieved convergence tolerance: 1.49e-08</code></pre>
</div>
</div>
</section>
</section>
<section id="多重比較" class="level2">
<h2 class="anchored" data-anchor-id="多重比較">多重比較</h2>
<p>数種類のデータ群に、一つのモデルを当てはめたら、群毎に推定したパラメータの違いが気になります。 複数群をお互いに比較することは多重比較といいます。 一般的には、 群毎にパラメータを推定する full model から群毎のデータをまとめて、一つのパラメータを推定する pooled model まで考えられます。 このとき、<code>nlsLM()</code> は使用できないので、<code>nls()</code> 関数を使います。 <code>nls()</code> の収束を助けるために、まずは pooled model の <code>nlsLM()</code> の結果を full model のパラメータ初期値にします。</p>
<p>では、データをすこし整理します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> dataset <span class="sc">|&gt;</span> <span class="fu">select</span>(seaweed, data) <span class="sc">|&gt;</span> <span class="fu">unnest</span>(data)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">=</span> dataset <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">seaweed =</span> <span class="fu">factor</span>(seaweed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>フルモデル (full model) の場合は群毎に、<span class="math inline">P_{max}</span>、<span class="math inline">\alpha</span>、<span class="math inline">R_d</span> を推定します。 プールモデル (pooled model) の場合は、群の区別をせず、1 セットのパラメータを推定します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># フルモデルの初期値を求める</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>poolmodel <span class="ot">=</span> <span class="fu">nlsLM</span>(np <span class="sc">~</span> <span class="fu">pecurve</span>(ppfd, pmax, rd, alpha), </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">start =</span> <span class="fu">list</span>(<span class="at">pmax =</span> <span class="dv">10</span>, <span class="at">rd =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>),</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> dataset, </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lower =</span> <span class="fu">c</span>(<span class="at">pmax =</span> <span class="dv">0</span>, <span class="at">rd =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>nlsLM()</code> は次のようにインデックスされた係数のモデルに対応していないので、<code>nls()</code> を使います。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>START <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">coef</span>(poolmodel), rep, <span class="dv">3</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>fullmodel <span class="ot">=</span> <span class="fu">nls</span>(np <span class="sc">~</span> <span class="fu">pecurve</span>(ppfd, pmax[seaweed], rd[seaweed], alpha[seaweed]), </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">start =</span> START, </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>AIC を確認すると、フルモデルの AIC が最も低いです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(poolmodel, fullmodel) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"model"</span>) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(AIC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  model        df   AIC
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
1 fullmodel    10  320.
2 poolmodel     4  353.</code></pre>
</div>
</div>
<p>すべてのモデルを当てはめて、AIC で比較することはできます。 3 変数・3 群のモデルの組み方は <span class="math inline">(3(3-1)/2)^3=125</span> とおりも考えられます。 125とおりのモデルを調べたくないので、Wald’s 検定でパラメータ比較をします。</p>
<div class=".rmdnote">
<p><strong>【重要】：ここで評価したフルモデルと海藻毎に当てはめたモデルのモデル係数に期待値は同じじゃない！</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fullmodel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: np ~ pecurve(ppfd, pmax[seaweed], rd[seaweed], alpha[seaweed])

Parameters:
       Estimate Std. Error t value Pr(&gt;|t|)    
pmax1  23.28613    4.73717   4.916 6.64e-06 ***
pmax2   5.24099    1.31169   3.996 0.000172 ***
pmax3   4.50104    1.45692   3.089 0.002983 ** 
rd1     2.07673    1.05259   1.973 0.052890 .  
rd2     0.43151    1.14443   0.377 0.707404    
rd3     0.82730    1.09158   0.758 0.451339    
alpha1  0.08580    0.01999   4.293 6.20e-05 ***
alpha2  0.16462    0.10022   1.643 0.105444    
alpha3  0.07176    0.05493   1.306 0.196200    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.073 on 63 degrees of freedom

Number of iterations to convergence: 14 
Achieved convergence tolerance: 5.833e-06</code></pre>
</div>
</div>
<p>推定した係数の違いはモデルの構造と関係しています。 それぞれの海藻に当てはめたとき、それぞれの海藻のモデルごとに独立した誤差項が存在するが、 上のフルモデルの場合 1 つの誤差項しかないです。</p>
<p>つまり、それぞれの海藻にはつぎのモデルを当てはめたので、<span class="math inline">\sigma</span> 3 つ存在します。 これで、係数の期待値と標準誤差がきまります。</p>
<p><span class="math display">
\begin{aligned}
\mu &amp;= P_{max} \left(1 - \exp\left(-\frac{\alpha}{P_{max}}I\right)\right)-R_d  \\
P_{net} &amp; \sim N(\mu, \sigma)
\end{aligned}
</span> フルモデルは次のようになります。</p>
<p><span class="math display">
\begin{aligned}
\mu_i &amp;= P_{max,i} \left(1 - \exp\left(-\frac{\alpha_{i}}{P_{max,i}}I\right)\right)-R_{d,i}  \\
P_{net,i} &amp; \sim N(\mu_i, \sigma)
\end{aligned}
</span> <span class="math inline">i</span> は海藻を区別するためのインデックス。 このモデルには 1 つの <span class="math inline">\sigma</span> しかないです。</p>
<p>この微妙な違いで、係数の期待値と標準誤差が変わります。</p>
</div>
<p>パラメータの多重比較は <a href="https://github.com/OnofriAndreaPG/aomisc/"><code>aomisc</code></a> のパッケージが有ると楽です。 インストール方法は <code>remotes</code> パッケージをつかって、github からインストールします。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"onofriAndreaPG/aomisc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>aomisc</code> パッケージの多重比較は Holm法を使います。</p>
<blockquote class="blockquote">
<p>Holm 法は p 値を小さい順になれべてから実施します。 最も小さい P 値の有意水準は <span class="math inline">\alpha / N</span> です。 <span class="math inline">N</span> は比較する回数です。 ここで <span class="math inline">P \leq \alpha / N</span> なら、 次の P 値を <span class="math inline">\alpha / (N-1)</span> で評価します。 <span class="math inline">P &gt; \alpha / (N-1)</span> なら、ここで検定が終わります。 帰無仮説を棄却できないまで、<span class="math inline">N-k</span> の補正で P 値を評価続けます。</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(aomisc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: drc</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: MASS</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MASS'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:patchwork':

    area</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    select</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
'drc' has been loaded.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Please cite R and 'drc' if used for a publication,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>for references type 'citation()' and 'citation('drc')'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'drc'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    gaussian, getInitial</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: plyr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>------------------------------------------------------------------------------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>You have loaded plyr after dplyr - this is likely to cause problems.
If you need functions from both plyr and dplyr, please load plyr first, then dplyr:
library(plyr); library(dplyr)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>------------------------------------------------------------------------------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'plyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:dplyr':

    arrange, count, desc, failwith, id, mutate, rename, summarise,
    summarize</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    compact</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: car</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: carData</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'car'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    recode</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    some</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: multcompView</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>cfs <span class="ot">=</span> <span class="fu">summary</span>(fullmodel)<span class="sc">$</span>coef</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">summary</span>(fullmodel)<span class="sc">$</span>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>pmax</code> の多重比較は次のとおりです。 3つ目の比較まで評価しました</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairComp</span>(cfs[rows,<span class="dv">1</span>], cfs[rows,<span class="dv">2</span>],<span class="at">dfr =</span> df[<span class="dv">2</span>], <span class="at">adjust =</span> <span class="st">"holm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pairs

     Simultaneous Tests for General Linear Hypotheses

Linear Hypotheses:
                 Estimate Std. Error t value Pr(&gt;|t|)   
pmax1-pmax2 == 0   18.045      4.915   3.671  0.00102 **
pmax1-pmax3 == 0   18.785      4.956   3.790  0.00102 **
pmax2-pmax3 == 0    0.740      1.960   0.377  0.70711   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
(Adjusted p values reported -- holm method)


$Letters
           Mean       SE CLD
pmax1 23.286128 4.737174   a
pmax2  5.240990 1.311692   b
pmax3  4.501039 1.456917   b</code></pre>
</div>
</div>
<p><code>alpha</code>と<code>rd</code>の場合、<span class="math inline">P &gt; \alpha/N</span> ので、3つ目比較までしません。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">=</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairComp</span>(cfs[rows,<span class="dv">1</span>], cfs[rows,<span class="dv">2</span>],<span class="at">dfr =</span> df[<span class="dv">2</span>], <span class="at">adjust =</span> <span class="st">"holm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pairs

     Simultaneous Tests for General Linear Hypotheses

Linear Hypotheses:
             Estimate Std. Error t value Pr(&gt;|t|)
rd1-rd2 == 0   1.6452     1.5549   1.058    0.882
rd1-rd3 == 0   1.2494     1.5164   0.824    0.882
rd2-rd3 == 0  -0.3958     1.5815  -0.250    0.882
(Adjusted p values reported -- holm method)


$Letters
         Mean       SE CLD
rd1 2.0767329 1.052591   a
rd2 0.4315057 1.144426   a
rd3 0.8273007 1.091576   a</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">=</span> <span class="dv">7</span><span class="sc">:</span><span class="dv">9</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairComp</span>(cfs[rows,<span class="dv">1</span>], cfs[rows,<span class="dv">2</span>],<span class="at">dfr =</span> df[<span class="dv">2</span>], <span class="at">adjust =</span> <span class="st">"holm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pairs

     Simultaneous Tests for General Linear Hypotheses

Linear Hypotheses:
                   Estimate Std. Error t value Pr(&gt;|t|)
alpha1-alpha2 == 0 -0.07882    0.10219  -0.771        1
alpha1-alpha3 == 0  0.01404    0.05846   0.240        1
alpha2-alpha3 == 0  0.09286    0.11428   0.813        1
(Adjusted p values reported -- holm method)


$Letters
             Mean         SE CLD
alpha1 0.08579966 0.01998607   a
alpha2 0.16461744 0.10021636   a
alpha3 0.07175792 0.05493227   a</code></pre>
</div>
</div>
<p><code>aomisc</code> パッケージを読み込むと、<code>drc</code> と <code>MASS</code> パッケージも同時に読み込まれます。 <code>tidyverse</code> を読み込んだあとに、<code>MASS</code> パッケージを読み込むと <code>MASS</code> の <code>select()</code> 関数が定義され、 <code>tidyverse</code> の <code>select()</code> が使えなくなります。 <code>aomisc</code> は不要になったので、次の 3 つのパッケージをディタッチ (detach, unload) します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">detach</span>(package<span class="sc">:</span>aomisc)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">detach</span>(package<span class="sc">:</span>drc)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="fu">detach</span>(package<span class="sc">:</span>MASS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="モデル係数の相関関係" class="level2">
<h2 class="anchored" data-anchor-id="モデル係数の相関関係">モデル係数の相関関係</h2>
<p>上で多重比較をしましたが、非線形モデルのパラメータはお互いとの相関関係が強いことが多いです。 このとき、多重比較にバイアス (bias) が入り、フェアな比較はできません。 光合成光曲線の解析から推定したパラメータの相関関係は次の図の通りです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>fm_cov  <span class="ot">=</span> <span class="fu">vcov</span>(fullmodel) <span class="co"># モデルパラメータの分散共分散行列</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>fm_corr <span class="ot">=</span> <span class="fu">cov2cor</span>(fm_cov) <span class="co"># モデルパラメータの相関行列</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>vname1 <span class="ot">=</span> <span class="fu">str_c</span>(<span class="fu">c</span>(<span class="st">"pmax"</span>, <span class="st">"alpha"</span>, <span class="st">"rd"</span>), <span class="st">"1"</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>vname2 <span class="ot">=</span> <span class="fu">str_c</span>(<span class="fu">c</span>(<span class="st">"pmax"</span>, <span class="st">"alpha"</span>, <span class="st">"rd"</span>), <span class="st">"2"</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>vname3 <span class="ot">=</span> <span class="fu">str_c</span>(<span class="fu">c</span>(<span class="st">"pmax"</span>, <span class="st">"alpha"</span>, <span class="st">"rd"</span>), <span class="st">"3"</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> <span class="fu">ggcorrplot</span>(fm_corr[vname1, vname1],     <span class="at">type =</span> <span class="st">"upper"</span>, <span class="at">show.diag =</span> T, <span class="at">lab =</span>T)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> <span class="fu">ggcorrplot</span>(fm_corr[vname2, vname2], <span class="at">type =</span> <span class="st">"upper"</span>, <span class="at">show.diag =</span> T, <span class="at">lab =</span> T)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">=</span> <span class="fu">ggcorrplot</span>(fm_corr[vname3, vname3], <span class="at">type =</span> <span class="st">"upper"</span>, <span class="at">show.diag =</span> T, <span class="at">lab =</span> T)</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">光合成光曲線の解析からもとめたパラメータの相関関係を示しています。種ごとにまとめて、3つの相関プロットに示した。（右）ウミトラノオ、（中）コブクロモク、（左）幼体。相関係数は -1 から　1 をとります。ウミトラノオ以外の場合では、パラメータごとの関係に正の相関があります。</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>vname1 <span class="ot">=</span> <span class="fu">str_c</span>(<span class="fu">c</span>(<span class="st">"pmax"</span>, <span class="st">"alpha"</span>, <span class="st">"rd"</span>), <span class="st">"1"</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>vname2 <span class="ot">=</span> <span class="fu">str_c</span>(<span class="fu">c</span>(<span class="st">"pmax"</span>, <span class="st">"alpha"</span>, <span class="st">"rd"</span>), <span class="st">"2"</span>)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>vname3 <span class="ot">=</span> <span class="fu">str_c</span>(<span class="fu">c</span>(<span class="st">"pmax"</span>, <span class="st">"alpha"</span>, <span class="st">"rd"</span>), <span class="st">"3"</span>)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> <span class="fu">ggcorrplot</span>(fm_cov[vname1, vname1],     <span class="at">type =</span> <span class="st">"upper"</span>, <span class="at">show.diag =</span> T, <span class="at">lab =</span>T, <span class="at">legend.title =</span> <span class="st">"Cov"</span>)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> <span class="fu">ggcorrplot</span>(fm_cov[vname2, vname2], <span class="at">type =</span> <span class="st">"upper"</span>, <span class="at">show.diag =</span> T, <span class="at">lab =</span> T, <span class="at">legend.title =</span> <span class="st">"Cov"</span>)</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">=</span> <span class="fu">ggcorrplot</span>(fm_cov[vname3, vname3], <span class="at">type =</span> <span class="st">"upper"</span>, <span class="at">show.diag =</span> T, <span class="at">lab =</span> T, <span class="at">legend.title =</span> <span class="st">"Cov"</span>)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="nonlinear_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">光合成光曲線の解析からもとめたパラメータの共分散を示しています。種ごとにまとめて、3つの共分散プロットに示した。（右）ウミトラノオ、（中）コブクロモク、（左）幼体。分散は正の値しか取れませんが、共分散は負の値をとっても大丈夫です。ウミトラノオの場合は負の値になっています。</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>モデル係数はお互いに独立していないことが明確ですね。 これにより、Wald’s 検定の結果はそのまま受け入れないほうがいいです。</p>
</section>
<section id="ガウス誤差伝播法" class="level2">
<h2 class="anchored" data-anchor-id="ガウス誤差伝播法">ガウス誤差伝播法</h2>
<p>ガウス誤差伝播法 (Gaussian error propagation, GEP) は直接推定したパラメータ（係数）から 間接的に求めたパラメータの誤差を推定するための手法です。 GEP においては、誤差が正規分布に従うことと、パラメータ推定にバイアスがないことが条件です。 ところがほとんどのモデルは、この条件を満たしていません。 それにしても、推定した誤差がパラメータ期待値の 10% を下回れば、信頼できる結果と考えられます。</p>
<p>GEPを実施するには、つぎの式を応用します。 <span class="math inline">\sigma_f^2</span> は間接的に求めたパラメータ <span class="math inline">f</span> の分散です。 <span class="math inline">g</span> は間接的に求めたパラメータ <span class="math inline">f</span> の偏微分方程式の行列です。 <span class="math inline">V</span> は直接推定したパラメータの分散共分散行列です。</p>
<p><span class="math display">
\sigma_f^2 = \mathbf{g}^T\mathbf{V}\mathbf{g}
</span> <span class="math display">
\mathbf{g} =
\begin{bmatrix}
\frac{\partial f}{\partial \beta_x}\\
\frac{\partial f}{\partial \beta_y}\\
\frac{\partial f}{\partial \beta_z}\\
\end{bmatrix}
</span></p>
<p><span class="math display">
\mathbf{V} =
\begin{bmatrix}
\sigma_{xx}^2 &amp; \sigma_{xy}^2 &amp; \sigma_{xz}^2 \\
\sigma_{xy}^2 &amp; \sigma_{yy}^2 &amp; \sigma_{yz}^2 \\
\sigma_{xz}^2 &amp; \sigma_{yz}^2 &amp; \sigma_{zz}^2 \\
\end{bmatrix}
</span></p>
<p><span class="math display">
\sigma_f^2 =
\begin{bmatrix}
\frac{\partial f}{\partial \beta_x}&amp;
\frac{\partial f}{\partial \beta_y}&amp;
\frac{\partial f}{\partial \beta_z}\\
\end{bmatrix}
\begin{bmatrix}
\sigma_{xx}^2 &amp; \sigma_{xy}^2 &amp; \sigma_{xz}^2 \\
\sigma_{xy}^2 &amp; \sigma_{yy}^2 &amp; \sigma_{yz}^2 \\
\sigma_{xz}^2 &amp; \sigma_{yz}^2 &amp; \sigma_{zz}^2 \\
\end{bmatrix}
\begin{bmatrix}
\frac{\partial f}{\partial \beta_x}\\
\frac{\partial f}{\partial \beta_y}\\
\frac{\partial f}{\partial \beta_z}\\
\end{bmatrix}
</span></p>
<p><span class="math display">
\begin{aligned}
\sigma_f^2 &amp;=
\frac{\partial f}{\partial \beta_x}\left(\frac{\partial f}{\partial \beta_x}\sigma_{xx}^2 +\frac{\partial f}{\partial \beta_y}\sigma_{xy}^2 +\frac{\partial f}{\partial \beta_z}\sigma_{xz}^2\right) \\
{} &amp;+
\frac{\partial f}{\partial \beta_y}\left(\frac{\partial f}{\partial \beta_x}\sigma_{xy}^2 +\frac{\partial f}{\partial \beta_y}\sigma_{yy}^2 +\frac{\partial f}{\partial \beta_z}\sigma_{yz}^2\right) \\
{} &amp;+
\frac{\partial f}{\partial \beta_z}\left(\frac{\partial f}{\partial \beta_x}\sigma_{xz}^2 +\frac{\partial f}{\partial \beta_y}\sigma_{yz}^2 +\frac{\partial f}{\partial \beta_z}\sigma_{zz}^2\right)
\end{aligned}
</span></p>
<p><span class="math display">
\begin{aligned}
\sigma_f^2 &amp;=
\left(\frac{\partial f}{\partial \beta_x}\right)^2\sigma_{xx}^2 +
\frac{\partial f}{\partial \beta_x}\frac{\partial f}{\partial \beta_y}\sigma_{xy}^2 +
\frac{\partial f}{\partial \beta_x}\frac{\partial f}{\partial \beta_z}\sigma_{xz}^2 \\
{} &amp; +
\left(\frac{\partial f}{\partial \beta_y}\right)^2\sigma_{yy}^2 +
\frac{\partial f}{\partial \beta_y}\frac{\partial f}{\partial \beta_x}\sigma_{xy}^2 +
\frac{\partial f}{\partial \beta_y}\frac{\partial f}{\partial \beta_z}\sigma_{yz}^2 \\
{} &amp;+
\left(\frac{\partial f}{\partial \beta_z}\right)^2\sigma_{zz}^2 +
\frac{\partial f}{\partial \beta_z}\frac{\partial f}{\partial \beta_x}\sigma_{xz}^2 +
\frac{\partial f}{\partial \beta_z}\frac{\partial f}{\partial \beta_y}\sigma_{yz}^2
\end{aligned}
</span></p>
<p><span class="math display">
\begin{aligned}
\sigma_f^2 &amp;=
\left(\frac{\partial f}{\partial \beta_x}\right)^2\sigma_{xx}^2 +
\left(\frac{\partial f}{\partial \beta_y}\right)^2\sigma_{yy}^2 +
\left(\frac{\partial f}{\partial \beta_z}\right)^2\sigma_{zz}^2 \\
{} &amp;+
2\left(\frac{\partial f}{\partial \beta_x}\frac{\partial f}{\partial \beta_y}\sigma_{xy}^2 +
\frac{\partial f}{\partial \beta_x}\frac{\partial f}{\partial \beta_z}\sigma_{xz}^2 +
\frac{\partial f}{\partial \beta_y}\frac{\partial f}{\partial \beta_z}\sigma_{yz}^2 \right)
\end{aligned}
</span></p>
<p>参考文献：</p>
<ul>
<li>Tellinghuisen J. 2000. Statistical error propagation. Journal of Physical Chemistry A 104: 2834 - 2844.</li>
<li>Tellinghuisen J. 2001. Statistical error propagation. Journal of Physical Chemistry A 105: 3917 - 3921.</li>
<li>Lo E. 2005. Gaussian error propagation applied to ecological data: Post-ice-storm-downed woody biomass. Ecological Monographs 75: 451-466.</li>
</ul>
<p><span class="math display">
\sigma_f^2=\sum_{i = 1}^n \left(\frac{\partial q}{\partial x_i}\sigma_{x_i}\right)^2 + 2\sum_{i = 1}^n\sum_{j = 1,j\neq i}^n \left(\frac{\partial q}{\partial x_i}\frac{\partial q}{\partial x_j}\rho_{x_i x_j}\sigma_{x_i}\sigma_{x_j}\right)
</span></p>
<p>共分散と相関の関係は次の通りです。</p>
<p><span class="math display">
\overbrace{\rho_{xy}}^\text{相関}= \overbrace{\sigma_{xy}}^\text{共分散} / \underbrace{(\sigma_x\sigma_y)}_{x,y\;\text{の標準偏差}}
</span></p>
<p>では、Rで解析に使ったモデルの偏微分方程式を求めます。 光飽和点 <span class="math inline">(I_k)</span> と光補償点 <span class="math inline">(I_c)</span> の <code>formula</code> は次のように定義します。</p>
<p><span class="math display">
\begin{aligned}
I_k &amp; = f_1 = P_{max} / \alpha \\
I_c &amp; = f_2 = \frac{P_{max}}{\alpha} \ln\left(\frac{P_{max}}{P_{max} - R_d}\right) \\
\end{aligned}
</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>fic <span class="ot">=</span> ic <span class="sc">~</span> pmax<span class="sc">/</span>alpha</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>fik <span class="ot">=</span> ik <span class="sc">~</span> pmax<span class="sc">/</span>alpha <span class="sc">*</span> <span class="fu">log</span>(pmax<span class="sc">/</span>(pmax <span class="sc">-</span> rd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>fic</code> と <code>fik</code> は 3つの要素で組み立てられた formula です。 たとえば、<code>fic</code>の場合は次のようになっています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(fic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "formula"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(fic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>fic[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>`~`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>fic[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ic</code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>fic[[<span class="dv">3</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>pmax/alpha</code></pre>
</div>
</div>
<p>それぞれの偏微分方程式は次のとおりになります。</p>
<p>光補償点 <span class="math inline">(f_1)</span> の場合、 <span class="math inline">P_{max}</span> と <span class="math inline">\alpha</span> に対する式は次のとおりです。</p>
<p><span class="math display">
\begin{aligned}
\frac{\partial f_1}{\partial \alpha} &amp;= \frac{-P_{max}}{\alpha^2} \\
\frac{\partial f_1}{\partial P_{max}} &amp;= \frac{1}{\alpha} \\
\end{aligned}
</span></p>
<p>光飽和点 <span class="math inline">(f_2)</span> の場合、<span class="math inline">R_d</span>　もあるので式は次のとおりです。</p>
<p><span class="math display">
\begin{aligned}
\frac{\partial f_2}{\partial \alpha} &amp;= -\frac{P_{max}}{\alpha^2} \log\left(\frac{P_{max}}{P_{max} - R_d}\right) \\
\frac{\partial f_2}{\partial P_{max}} &amp;= \frac{1}{\alpha} \log\left(\frac{P_{max}}{P_{max} - R_d}\right)
+ \left(\frac{1}{\alpha} - \frac{P_{max}}{P_{max}-R_d}\right) \\
\frac{\partial f_2}{\partial R_{d}} &amp;= \frac{P_{max}}{\alpha\,(P_{max}-R_d)} \\
\end{aligned}
</span> Rでは、次の関数をつかって、光合成光曲線の光補償点と光飽和点の誤差を求めます。 関数に <code>rlang</code> パッケージの関数をつかています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>propagate_error <span class="ot">=</span> <span class="cf">function</span>(model, dmodel, parameters) {</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(rlang)  </span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  cfs <span class="ot">=</span> <span class="fu">coefficients</span>(model)    <span class="co"># モデル係数の期待値</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  vars <span class="ot">=</span> <span class="fu">all.vars</span>(dmodel[[<span class="dv">3</span>]]) <span class="co"># 偏微分方程式の対象となる変数</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  V <span class="ot">=</span> <span class="fu">vcov</span>(model)              <span class="co"># 当てはめたモデルの分散共分散行列</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>  V <span class="ot">=</span> V[parameters, parameters] <span class="co"># 必要な分散共分散の抽出</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  expectation <span class="ot">=</span> cfs[parameters] <span class="co"># 必要な期待値の抽出</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 偏微分方程式はここで求めています。</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  gradient_fn <span class="ot">=</span> <span class="fu">deriv</span>(dmodel[[<span class="dv">3</span>]], vars, <span class="at">function.arg =</span> T)</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>  ff <span class="ot">=</span> <span class="fu">expr</span>(<span class="fu">gradient_fn</span>(<span class="sc">!!!</span><span class="fu">syms</span>(vars)))</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">=</span>  <span class="fu">exprs</span>(<span class="sc">!!!</span>expectation)</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">=</span> <span class="fu">set_names</span>(tmp, vars)</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vars)) {</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">call2</span>(<span class="st">"="</span>, <span class="fu">expr</span>(<span class="sc">!!</span>vars[i]), expectation[i]) <span class="sc">|&gt;</span> <span class="fu">eval</span>()</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>  G <span class="ot">=</span> <span class="fu">eval</span>(ff)</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>  G <span class="ot">=</span> <span class="fu">attributes</span>(G)<span class="sc">$</span>gradient <span class="sc">|&gt;</span> <span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># g^T V g</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>((<span class="fu">t</span>(G) <span class="sc">%*%</span> V) <span class="sc">%*%</span> G)</span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>直接推定したモデル係数を抽出して、期待値と標準誤差だけ残します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>cfsout <span class="ot">=</span> <span class="fu">summary</span>(fullmodel)<span class="sc">$</span>coef <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"parameter"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(parameter, <span class="at">est=</span>Estimate, <span class="at">se =</span> <span class="st">`</span><span class="at">Std. Error</span><span class="st">`</span>) <span class="sc">|&gt;</span> </span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">str_extract</span>(parameter, <span class="st">"[0-9]"</span>),</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">parameter =</span> <span class="fu">str_extract</span>(parameter, <span class="st">"[A-z]+"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> parameter,</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> <span class="fu">c</span>(est, se),</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_glue =</span> <span class="st">"{.value}_{parameter}"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>間接的に推定したパラメータを追加します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>cnames <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Seaweed"</span>, <span class="st">"Parameter"</span>, <span class="st">"Estimate"</span>, <span class="st">"SE"</span>)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>cfsout <span class="ot">=</span> cfsout <span class="sc">|&gt;</span> </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">est_ic =</span> est_pmax <span class="sc">/</span> est_alpha,</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">est_ik =</span> est_pmax <span class="sc">/</span> est_alpha <span class="sc">*</span> <span class="fu">log</span>(est_pmax <span class="sc">/</span> (est_pmax <span class="sc">-</span> est_rd))) <span class="sc">|&gt;</span> </span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pmax =</span> <span class="fu">str_c</span>(<span class="st">"pmax"</span>, id),</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">alpha =</span> <span class="fu">str_c</span>(<span class="st">"alpha"</span>, id),</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">rd =</span> <span class="fu">str_c</span>(<span class="st">"rd"</span>, id),</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">seaweed =</span> <span class="fu">c</span>(<span class="st">"ウミトラノオ"</span>, <span class="st">"コブクロモク"</span>, <span class="st">"幼体"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>propagate_error()</code> をそれぞれの海藻に適応します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>apply_propagate_error_fic <span class="ot">=</span> <span class="cf">function</span>(pmax, alpha, rd) {</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    fic <span class="ot">=</span> ic <span class="sc">~</span> pmax <span class="sc">/</span> alpha</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">propagate_error</span>(fullmodel, fic, <span class="fu">c</span>(pmax, alpha))</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>apply_propagate_error_fik <span class="ot">=</span> <span class="cf">function</span>(pmax, alpha, rd) {</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>  fik <span class="ot">=</span> ik <span class="sc">~</span> pmax <span class="sc">/</span> alpha <span class="sc">*</span> <span class="fu">log</span>(pmax <span class="sc">/</span> (pmax <span class="sc">-</span> rd))</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">propagate_error</span>(fullmodel, fik, <span class="fu">c</span>(pmax, alpha, rd))</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>cfsout <span class="ot">=</span> cfsout <span class="sc">|&gt;</span> </span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">se_ic =</span> <span class="fu">pmap_dbl</span>(<span class="fu">list</span>(pmax, alpha, rd), apply_propagate_error_fic)) <span class="sc">|&gt;</span> </span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">se_ik =</span> <span class="fu">pmap_dbl</span>(<span class="fu">list</span>(pmax, alpha, rd), apply_propagate_error_fik)) <span class="sc">|&gt;</span> </span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>           <span class="fu">select</span>(<span class="sc">-</span>alpha, <span class="sc">-</span>pmax, <span class="sc">-</span>rd) <span class="sc">|&gt;</span> </span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">matches</span>(<span class="st">"est_|se_"</span>),</span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"stat"</span>, <span class="st">"par"</span>),</span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_pattern =</span> <span class="st">"(est|se)_(.*)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> stat, <span class="at">values_from =</span> value) <span class="sc">|&gt;</span> </span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(par, id) <span class="sc">|&gt;</span> </span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rlang</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'rlang'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:purrr':

    %@%, as_function, flatten, flatten_chr, flatten_dbl, flatten_int,
    flatten_lgl, flatten_raw, invoke, splice</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>cfsout <span class="sc">|&gt;</span> </span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">2</span>),</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col.names =</span> cnames)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table>
 <thead>
  <tr>
   <th style="text-align:left;"> Seaweed </th>
   <th style="text-align:left;"> Parameter </th>
   <th style="text-align:right;"> Estimate </th>
   <th style="text-align:right;"> SE </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ウミトラノオ </td>
   <td style="text-align:left;"> alpha </td>
   <td style="text-align:right;"> 0.086 </td>
   <td style="text-align:right;"> 0.02 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> コブクロモク </td>
   <td style="text-align:left;"> alpha </td>
   <td style="text-align:right;"> 0.165 </td>
   <td style="text-align:right;"> 0.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 幼体 </td>
   <td style="text-align:left;"> alpha </td>
   <td style="text-align:right;"> 0.072 </td>
   <td style="text-align:right;"> 0.05 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ウミトラノオ </td>
   <td style="text-align:left;"> ic </td>
   <td style="text-align:right;"> 271.401 </td>
   <td style="text-align:right;"> 109.63 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> コブクロモク </td>
   <td style="text-align:left;"> ic </td>
   <td style="text-align:right;"> 31.837 </td>
   <td style="text-align:right;"> 17.59 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 幼体 </td>
   <td style="text-align:left;"> ic </td>
   <td style="text-align:right;"> 62.725 </td>
   <td style="text-align:right;"> 49.15 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ウミトラノオ </td>
   <td style="text-align:left;"> ik </td>
   <td style="text-align:right;"> 25.353 </td>
   <td style="text-align:right;"> 9.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> コブクロモク </td>
   <td style="text-align:left;"> ik </td>
   <td style="text-align:right;"> 2.735 </td>
   <td style="text-align:right;"> 6.34 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 幼体 </td>
   <td style="text-align:left;"> ik </td>
   <td style="text-align:right;"> 12.739 </td>
   <td style="text-align:right;"> 11.54 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ウミトラノオ </td>
   <td style="text-align:left;"> pmax </td>
   <td style="text-align:right;"> 23.286 </td>
   <td style="text-align:right;"> 4.74 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> コブクロモク </td>
   <td style="text-align:left;"> pmax </td>
   <td style="text-align:right;"> 5.241 </td>
   <td style="text-align:right;"> 1.31 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 幼体 </td>
   <td style="text-align:left;"> pmax </td>
   <td style="text-align:right;"> 4.501 </td>
   <td style="text-align:right;"> 1.46 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ウミトラノオ </td>
   <td style="text-align:left;"> rd </td>
   <td style="text-align:right;"> 2.077 </td>
   <td style="text-align:right;"> 1.05 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> コブクロモク </td>
   <td style="text-align:left;"> rd </td>
   <td style="text-align:right;"> 0.432 </td>
   <td style="text-align:right;"> 1.14 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 幼体 </td>
   <td style="text-align:left;"> rd </td>
   <td style="text-align:right;"> 0.827 </td>
   <td style="text-align:right;"> 1.09 </td>
  </tr>
</tbody>
</table>

</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>