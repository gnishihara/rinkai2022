{
  "hash": "f150467cd0ecd0cb051cb737bd47680d",
  "result": {
    "markdown": "---\ntitle: \"一元配置分散分析\"\nsubtitle: Comparing multiple groups with ANOVA\nformat: \n  html:\n    html-math-method: katex\nreference-location: margin\ncitation-location: margin\n---\n\n::: {.cell warnings='false'}\n\n:::\n\n\n\n::: {.callout-note}\n解析の紹介に使った疑似データは次のようにつくりました。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(2021) # 疑似乱数のシードを設定する\nnA = 6         # サンプル数を決める\nnB = 6\nnC = 6\nmeanA = 20     # 真の平均値\nmeanB = 22\nmeanC = 18\nsigmaA = 1     # 真の標準偏差\nsigmaB = 1\nsigmaC = 1\nsiteA = rnorm(nA, meanA, sigmaA) |> round(1) # データを発生する\nsiteB = rnorm(nB, meanB, sigmaB) |> round(1)\nsiteC = rnorm(nC, meanC, sigmaC) |> round(1)\n\n# tibble を組み立てる\ndset = tibble(g = c(\"A\", \"B\", \"C\"), data = list(siteA, siteB, siteC)) |> \n  unnest(data) |> \n  mutate(g = factor(g))\n```\n:::\n\n:::\n\n## ノコギリモク (*Sargassum macrocarpum*) の疑似データ\n\n::: {.grid}\n\n::: {.g-col-4}\n\n::: {.cell hash='anova_cache/html/juvenile-sargassum-figure_3a78b6ea7286e06c5539cdc163a125fb'}\n::: {.cell-output-display}\n![The width of the rope is 6 mm, so the juvenile is about 20 mm in width.](anova_files/figure-html/juvenile-sargassum-figure-1.png){width=750}\n:::\n:::\n\n:::\n::: {.g-col-8}\n\n\n::: {#tbl-juvenile-dataset .cell tbl-cap='Size (mm) of juvenile Sargassum macrocarpum（ノコギリモク）.'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Sample </th>\n   <th style=\"text-align:right;\"> Site A </th>\n   <th style=\"text-align:right;\"> Site B </th>\n   <th style=\"text-align:right;\"> Site C </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 19.9 </td>\n   <td style=\"text-align:right;\"> 22.3 </td>\n   <td style=\"text-align:right;\"> 18.2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 20.6 </td>\n   <td style=\"text-align:right;\"> 22.9 </td>\n   <td style=\"text-align:right;\"> 19.5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:right;\"> 20.3 </td>\n   <td style=\"text-align:right;\"> 22.0 </td>\n   <td style=\"text-align:right;\"> 19.6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 20.4 </td>\n   <td style=\"text-align:right;\"> 23.7 </td>\n   <td style=\"text-align:right;\"> 16.2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:right;\"> 20.9 </td>\n   <td style=\"text-align:right;\"> 20.9 </td>\n   <td style=\"text-align:right;\"> 19.6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:right;\"> 18.1 </td>\n   <td style=\"text-align:right;\"> 21.7 </td>\n   <td style=\"text-align:right;\"> 18.1 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n:::\n:::\n\n::: {.callout-note}\nノコギモクの大きさは @tbl-juvenile-dataset に示しています。\nサンプルは 3 箇所（3群）から採取しました。\n各サンプルに個体数番号もふっています。\n\nデータは 上のノートに紹介したコードで発生しました。\n:::\n\n\n## データの可視化\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(dset) + \n  geom_point(aes(x = g, y = data, color = g),\n             size = 2,\n             position = position_jitter(0.1)) +\n  scale_color_manual(\"\", values = viridis::viridis(4)) +\n  labs(y = \"Width (mm)\", x = \"Site\") +\n  theme(legend.position = \"top\")\n```\n\n::: {.cell-output-display}\n![](anova_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n各サイトの平均値 ($\\overline{x}$), 標準偏差 ($s$), と標準誤差 (s.e.) は、\n\n* $\\overline{x}_A=$ 20; $s_A=$ 1; s.e. = 0.41\n* $\\overline{x}_B=$ 22.2; $s_B=$ 0.97; s.e. = 0.4\n* $\\overline{x}_C=$ 18.5; $s_C=$ 1.34; s.e. = 0.55\n\n\n## 仮説を決める {#hypothesis}\n\n::: {.callout-important}\n解析する前に作業仮説、帰無仮説、対立仮説を設定する必要があります。\n\n:::\n\n::: {.callout-note appearance=\"simple\"}\n## Working hypothesis\n\n**作業仮設**: ノコギリモクの大きさは採取した場所によって異なる。 \n:::\n\n* 記述統計量によって、平均値以外の統計量（標準偏差と標準誤差）は似ています。\n- $\\overline{x}_A=$ 20; $s=$ 1; s.e. = 0.41\n- $\\overline{x}_B=$ 22.2; $s=$ 0.97; s.e. = 0.4\n- $\\overline{x}_C=$ 18.5; $s=$ 1.34; s.e. = 0.55\n\n### 帰無仮説と対立仮説\n\n統計学的に解析するための帰無仮説と対立仮説を決めます。\n\n* **$H_0$ (null hypothesis 帰無仮説・ヌル仮説):** ノコギリモクの大きさは場所によって異ならない\n* **$H_A$ (alternative hypothesis 対立仮設):**  ノコギリモクの大きさは場所によって異なる\n\n## ナイーブな ペア毎の t 検定\n\nとりあえず、場所のペア毎の t 検定を実施します。\nこのとき、3 つの帰無仮説が必要なので、@hypothesis と違います。\n\n* H~0,A-B~: Site A と Site B の大きさは同じ\n* H~0,A-C~: Site A と Site C の大きさは同じ\n* H~0,B-C~: Site B と Site C の大きさは同じ\n\nでは、それぞれの t 検定を実施します。\n\n### Site A and B の t 検定\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresultAB = dset |> filter(!str_detect(g, \"C\"))\nresultAB = t.test(data ~ g, data = resultAB)\nresultAB\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tWelch Two Sample t-test\n\ndata:  data by g\nt = -3.8886, df = 9.9893, p-value = 0.003022\nalternative hypothesis: true difference in means between group A and group B is not equal to 0\n95 percent confidence interval:\n -3.486976 -0.946357\nsample estimates:\nmean in group A mean in group B \n       20.03333        22.25000 \n```\n:::\n:::\n\n\n\nt値は -3.889、P値は 0.003 です。\n0.003 $\\le$ 0.05 なので、帰無仮説は棄却できます。\n\n### Site A and C の t 検定\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresultAC = dset |> filter(!str_detect(g, \"B\"))\nresultAC = t.test(data ~ g, data = resultAC)\nresultAC\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tWelch Two Sample t-test\n\ndata:  data by g\nt = 2.1968, df = 9.2717, p-value = 0.05477\nalternative hypothesis: true difference in means between group A and group C is not equal to 0\n95 percent confidence interval:\n -0.03773888  3.03773888\nsample estimates:\nmean in group A mean in group C \n       20.03333        18.53333 \n```\n:::\n:::\n\n\nt値は 2.197、P値は 0.0548 です。\n0.0548 $\\ge$ 0.05 なので、帰無仮説は棄却できません。\n\n### Site B and C の t 検定\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresultBC = dset |> filter(!str_detect(g, \"A\"))\nresultBC = t.test(data ~ g, data = resultBC)\nresultBC\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tWelch Two Sample t-test\n\ndata:  data by g\nt = 5.5063, df = 9.1228, p-value = 0.0003595\nalternative hypothesis: true difference in means between group B and group C is not equal to 0\n95 percent confidence interval:\n 2.192862 5.240472\nsample estimates:\nmean in group B mean in group C \n       22.25000        18.53333 \n```\n:::\n:::\n\n\nt値は 5.506、P値は 0.0004 です。\n0.0004 $\\le$ 0.05 なので、帰無仮説は棄却できます。\n\n**t検定の結果をまとめました。**\n\n\n::: {#tbl-three-t-tests .cell tbl-cap='Summary of three t-tests.'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Pair </th>\n   <th style=\"text-align:right;\"> Difference </th>\n   <th style=\"text-align:right;\"> t-value </th>\n   <th style=\"text-align:right;\"> P-value </th>\n   <th style=\"text-align:right;\"> d.f. </th>\n   <th style=\"text-align:left;\"> 95% CI </th>\n   <th style=\"text-align:left;\"> Is P ≤ 0.05? </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> B-A </td>\n   <td style=\"text-align:right;\"> -2.216667 </td>\n   <td style=\"text-align:right;\"> -3.888623 </td>\n   <td style=\"text-align:right;\"> 0.0030224 </td>\n   <td style=\"text-align:right;\"> 9.989348 </td>\n   <td style=\"text-align:left;\"> -3.487 to -0.95 </td>\n   <td style=\"text-align:left;\"> Yes </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> C-A </td>\n   <td style=\"text-align:right;\"> 1.500000 </td>\n   <td style=\"text-align:right;\"> 2.196821 </td>\n   <td style=\"text-align:right;\"> 0.0547748 </td>\n   <td style=\"text-align:right;\"> 9.271711 </td>\n   <td style=\"text-align:left;\"> -0.038 to  3.04 </td>\n   <td style=\"text-align:left;\"> No </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> C-B </td>\n   <td style=\"text-align:right;\"> 3.716667 </td>\n   <td style=\"text-align:right;\"> 5.506257 </td>\n   <td style=\"text-align:right;\"> 0.0003595 </td>\n   <td style=\"text-align:right;\"> 9.122821 </td>\n   <td style=\"text-align:left;\"> 2.193 to  5.24 </td>\n   <td style=\"text-align:left;\"> Yes </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nd.f. は Welch-Satterthwaite 式で求めた自由度^[degrees-of-freedom]、95% CI は 95% 信頼区間です。\n\n## 第１種の誤り (accepting a false H~0~)\n\n::: {.callout-note}\n## 第１種の誤り\nH~0~ が **FALSE** のときに帰無仮説を棄却できなかった誤りです。\n:::\n\nt 検定を 1 回実施したときの誤りは \n\n$$\n\\text{Type I error rate} = \\alpha = 0.05\n$$\n\nt 検定を 2 回実施したときの誤りは \n\n$$\n1 - (1 - \\alpha) \\times (1 - \\alpha) = 1 - (1-\\alpha)^2=0.0975\n$$\n\nt 検定を 3 回実施したときの誤りは \n\n$$\n1 - (1 - \\alpha) \\times (1 - \\alpha) \\times (1 - \\alpha)= 1 - (1-\\alpha)^3=0.142625\n$$\n\nt 検定を $h$ 回実施したとき、第１種の誤りは $1 - (1-\\alpha)^h$ です。\n\n\n### 群が増えると大変なことなる\n\n$n$ 群のサンプルの全ペア毎の比較がしたい場合、 $h$ のペア $(k = 2)$ が存在します。\n\n\n$$\nh = \\binom{n}{k}=\\frac{n!}{k!(n-k!)}\n$$\n\nペア毎の $h$ の数を求める式は次のようになります。\n\n$$\nh = \\binom{n}{2}=\\frac{n!}{2!(n-2!)} = \\frac{n(n-1)}{2}\n$$\n\n\n例えば、5 site の場合、10 のペアが存在します。\nペア毎の t 検定をしたら、第１種の誤りは \n\n$$\n1 - (1-0.05)^{10}=0.4012631\n$$\n\n::: {.callout-note}\n## R での求め方\n\n\n::: {.cell}\n\n```{.r .cell-code}\nalpha = 0.05       # 有意水準\nk = 2              # ペアだから 2\nn = 5              # 比較する群・場所・グループの数\nh = choose(n, k)   # ペアの数\n1 - (1 - alpha)^h  # 第１種の誤り\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.4012631\n```\n:::\n:::\n\n\n:::\n\n\n::: {.cell}\n::: {.cell-output-display}\n![比較する群が増えると、t 検定を繰り返して実施すると、第１種の誤りを起こしやすい。](anova_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n# 一元配置分散分析\n\n## One-Way ANOVA (一元配置分散分析)\n\n複数群（因子の水準）の解析は **一元配置分散分析)**^[One-Way ANOVA (One-Way Analysis of Variance] 用います。\n\n* 因子・要因^[factor]：説明変数、一般的には離散型な変数\n* 水準^[level, factor level]：説明変数における値、レベル、要素\n\n分散分析の帰無仮説は、\n\n$$\n\\mu_1 = \\mu_2 = \\cdots = \\mu_i\n$$\n\nつまり、一つの検定で複数群の平均値を同時に解析するから、第１種の誤りは 0.05 に抑えられる。\n\n分散分析のモデル式は次のように表せます。\n\n$$\nx_{ij} = \\mu_i + \\epsilon_{ij}\n$$\n\n水準 $i$ とサンプル $j$ の値は $x_{ij}$です。\n水準 $i$ の平均値は $\\mu_i$ です。\nモデルの残渣^[residual]または誤差項^[error term]は $\\epsilon_{ij}$ です。\n\n\n\n## 一元配置分散分析表\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Factor </th>\n   <th style=\"text-align:left;\"> Degrees-of-freedom (df) </th>\n   <th style=\"text-align:left;\"> Sum-of-Squares (SS) </th>\n   <th style=\"text-align:left;\"> Mean-square (MS) </th>\n   <th style=\"text-align:left;\"> F-value </th>\n   <th style=\"text-align:left;\"> P-value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> $df_A = I-1$ </td>\n   <td style=\"text-align:left;\"> $SS_A$ </td>\n   <td style=\"text-align:left;\"> $MS_A = SS_A / df_A$ </td>\n   <td style=\"text-align:left;\"> $MS_A / MS_R$ </td>\n   <td style=\"text-align:left;\"> $qf(1-α, df_A, df_R)$ </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> e </td>\n   <td style=\"text-align:left;\"> $df_R = I(J-1)$ </td>\n   <td style=\"text-align:left;\"> $SS_R$ </td>\n   <td style=\"text-align:left;\"> $MS_R = SS_R / df_R$ </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> $df_T =IJ-1$ </td>\n   <td style=\"text-align:left;\"> $SS_T$ </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\">  </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n\n* 因子は $A$^[factor]\n* 残渣は $e$^[residual]\n* 水準数は $I$^[number of levels]\n* サンプル数は　$J$^[number of samples]\n* 水準間平方和は $SS_A$^[among levels sum-of-squares (SS)]\n* 残渣平方和は $SS_R$^[residual SS]\n* 総平方和は $SS_T$^[total SS]\n* 水準間平均平方は $MS_A$^[among levels mean square (MS)]\n* 残渣平均平方は $MS_R$^[residual mean square (MS)]\n* F値^[F-value]は MS の比です。\n\n## 平方和の方程式\n\n$$\n\\underbrace{\\sum_{i=1}^I\\sum_{j=1}^J(x_{ij} - \\overline{\\overline{x}})^2 }_{\\text{総平方和}\\;(SS_T)} =\n\\overbrace{J\\sum_{i=1}^I(\\overline{x}_{i}-\\overline{\\overline{x}})^2}^{\\text{水準間平方和}\\;SS_A} +\n\\underbrace{\\sum_{i=1}^I\\sum_{j=1}^J(x_{ij} - \\overline{x}_i)^2}_{\\text{残渣平方和}\\;SS_R}\n$$\n\n標本平均は $\\bar{x}_i$、総平均は $\\bar{\\bar{x}}$ です。\n\n\n## Decomposing the sum-of-squares\n\n\n::: {.cell}\n\n:::\n\n::: {.cell layout-ncol=\"2\"}\n::: {.cell-output-display}\n![残渣平方和：各サンプルの値は点、グループ毎の平均値は黒線で示しています。黒線から点の縦線は残渣を表しています。](anova_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![水準間平方和：各グループの平均値は点、総平均は黒線で示しています。黒線から点の縦線はグループ毎の平均値と総平均の違いを表しています。](anova_files/figure-html/unnamed-chunk-14-2.png){width=672}\n:::\n:::\n\n\n\n## 分散分析の統計量\n\n\n$$\nF = \\left . \\frac{SS_A}{I-1} \\right / \\frac{SS_R}{I(J-1)}  = \\frac{SS_A}{SS_R} \\frac{I(J-1)}{I-1} = \\frac{MS_A}{MS_R}\n$$\n\n\nF値は 自由度 $\\text{df}_1 = I-1, \\text{df}_2 = I(J-1)$ のF分布に従います。\n水準の数は $I$、水準ごとのサンプルの数は $J$ です。\n\n:::{.callout-note}\n\n* F値の分子^[numerator] が大きとき、または分母^[denominator]が小さいとき、F値は大きいです。\n* F値とP値は反比例します。\n\n:::\n\n## F値の確率密度関数\n\n$$\nP(x|\\text{df}_1, \\text{df}_2) = \\frac{1}{\\mathrm{B}\\left(\\frac{\\text{df}_1}{2}, \\frac{\\text{df}_2}{2}\\right)}\\left(\\frac{\\text{df}_1}{\\text{df}_2}\\right)^{\\left(\\frac{\\text{df}_1}{2}\\right)}x^{\\left(\\frac{\\text{df}_1}{2}-1\\right)}\\left(1+\\frac{\\text{df}_1}{\\text{df}_2}x\\right)^{\\left(-\\frac{\\text{df}_1+\\text{df}_2}{2}\\right)}\n$$\n$\\mathrm{B}(\\text{df}_1, \\text{df}_2)=\\int_0^1t^{x-1}(1-t)^{y-1}dt$ は ベータ関数^[Beta function] といいます。\n$\\text{df}_1$ と $\\text{df}_2$ は自由度、$x$ は確率変数です。\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![自由度が変わるとF分布の形が変わります。](anova_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n## 一元配置分散分析表の仮定\n\n分散分析するときに注意する仮定\n\n* 水準毎の母分散は等しい\n* 残渣は正規分布に従う\n* 観測値はお互いに独立であり、同一分布に従う\n* 観測変数は連続変数^[continuous]\n* 説明変数は離散変数^[discrete]\n\n\n## Rにおける解析\n\n解析例に使うデータは `thedata.csv` に保存したので、まずは読み込みます。\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read data from a csv file\ndset = read_csv(\"thedata.csv\")\n```\n:::\n\n\nデータをグループ化したあと、最初の 2 行を表示する。\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndset |> group_by(site) |> slice(1:2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 2\n# Groups:   site [3]\n  site    obs\n  <fct> <dbl>\n1 A      19.9\n2 A      20.6\n3 B      22.3\n4 B      22.9\n5 C      18.2\n6 C      19.5\n```\n:::\n:::\n\n\n帰無仮説を当てはめる。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnullmodel = lm(obs ~ 1, data = dset) # 帰無モデル、ヌルモデル\n```\n:::\n\n\nフルモデル（対立仮説）を当てはめる。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfullmodel = lm(obs ~ site, data = dset) # 対立モデル、フルモデル\n```\n:::\n\n\n\n## 分散分析の結果\n\n**帰無仮説と対立仮説のモデル結果を用いた方法。**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(nullmodel, fullmodel, test = \"F\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nModel 1: obs ~ 1\nModel 2: obs ~ site\n  Res.Df    RSS Df Sum of Sq      F    Pr(>F)    \n1     17 60.656                                  \n2     15 18.702  2    41.954 16.825 0.0001471 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n::: {.cell}\n\n:::\n\n\nF値は 16.825、自由度は df~1~ = 2 と df~2~ = 15 です。\nよって、P値は 0.000147 です。\n有意水準が $\\alpha = 0.05$ 、自由度が　(2, 15) \nのときのF値は 3.682.\n\n**フルモデルの結果でけ用いた解析**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(fullmodel)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: obs\n          Df Sum Sq Mean Sq F value    Pr(>F)    \nsite       2 41.954 20.9772  16.825 0.0001471 ***\nResiduals 15 18.702  1.2468                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n**`aov()` 関数を用いた方法**\n\nこのとき、`lm()` は不要です。\n\n\n::: {.cell}\n\n```{.r .cell-code}\naovout = aov(obs ~ site, data = dset)\nsummary(aovout)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            Df Sum Sq Mean Sq F value   Pr(>F)    \nsite         2  41.95  20.977   16.82 0.000147 ***\nResiduals   15  18.70   1.247                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n::: {.callout-important}\n分散分析の帰無仮説は $\\mu_0 = \\mu_1 = \\cdots \\mu_i$ なので、\nペア間の検定ではないです。\n:::\n\n# 多重比較^[multiple comparisons]\n\n## 多重比較\n\n分散分析の帰無仮説を棄却したら、ペア毎の比較がしたくなります。\n第１種の誤りを抑える多重比較の検定は豊富に存在します。\n\n1. Bonferroni Procedure (ボンフェロニ法)\n1. Holm-Bonferroni Method (ホルム = ボンフェロニ法)\n1. Tukey’s Honest Signiﬁcant Difference Test (テューキーの HSD 検定)\n1. Tukey-Kramer method, Tukey’s test\n1. Scheffe’s Method (シェッフェの方法)\n1. Dunnett’s Test (ダネットの検定)\n1. Fisher’s Least Signiﬁcant Difference (フィッシャーの最小有意差法)\n1. Duncan’s new multiple range test (ダンカンの新多重範囲検定)\n\n1 から 4 はペア毎の比較です。\nダネットの検定は水準に対する比較です。\nフィッシャーとダンカンの検定の第１種の誤りは高いので、使用しないでください。\n\n## 多重比較用 R パッケージ\n\n多重比較用の関数は次のパッケージにあります。\n\n* `multcomp`\n* `emmeans`\n\nここでは、`emmeans` を紹介します。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(emmeans) # 多重比較用パッケージ\nlibrary(nlme)    # gls() 関数はこのパッケージにある\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'nlme'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:dplyr':\n\n    collapse\n```\n:::\n:::\n\n\n## 繰り返しウェルチの t 検定\n\n**説明のために紹介しています。実際の解析には使わないでください。**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglsmodel = gls(obs ~ site, data = dset, \n               weights = varIdent(form = ~ 1|site))\nemout = emmeans(glsmodel, specs = pairwise ~ site, adjust = \"none\")\nemout$contrasts |> summary(infer =T)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate    SE   df lower.CL upper.CL t.ratio p.value\n A - B       -2.22 0.570 9.99  -3.4870   -0.946  -3.889  0.0030\n A - C        1.50 0.683 9.26  -0.0381    3.038   2.197  0.0548\n B - C        3.72 0.675 9.11   2.1925    5.241   5.506  0.0004\n\nDegrees-of-freedom method: satterthwaite \nConfidence level used: 0.95 \n```\n:::\n:::\n\n\n第１種の誤りを調整していません。\n\n\n## 繰り返し t 検定\n\n**説明のために紹介しています。実際の解析には使わないでください。**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemout = emmeans(fullmodel, specs = pairwise ~ site, data = dset, adjust = \"none\")\nemout$contrasts |> summary(infer =T)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate    SE df lower.CL upper.CL t.ratio p.value\n A - B       -2.22 0.645 15   -3.591   -0.843  -3.438  0.0037\n A - C        1.50 0.645 15    0.126    2.874   2.327  0.0344\n B - C        3.72 0.645 15    2.343    5.091   5.765  <.0001\n\nConfidence level used: 0.95 \n```\n:::\n:::\n\n\n第１種の誤りを調整していません。\n\n## ボンフェロニ法\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemout = emmeans(fullmodel, specs = pairwise ~ site, data=dset, adjust = \"bonferroni\")\nemout$contrasts |> summary(infer =T)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate    SE df lower.CL upper.CL t.ratio p.value\n A - B       -2.22 0.645 15   -3.953    -0.48  -3.438  0.0110\n A - C        1.50 0.645 15   -0.237     3.24   2.327  0.1032\n B - C        3.72 0.645 15    1.980     5.45   5.765  0.0001\n\nConfidence level used: 0.95 \nConf-level adjustment: bonferroni method for 3 estimates \nP value adjustment: bonferroni method for 3 tests \n```\n:::\n:::\n\n\nP値は $p_{adj} =m\\times p$ によって求められました. \n\n\n## ホルム=ボンフェロニ法\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemout = emmeans(fullmodel, specs = pairwise ~ site, data=dset, adjust = \"holm\")\nemout$contrasts |> summary(infer =T)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate    SE df lower.CL upper.CL t.ratio p.value\n A - B       -2.22 0.645 15   -3.953    -0.48  -3.438  0.0073\n A - C        1.50 0.645 15   -0.237     3.24   2.327  0.0344\n B - C        3.72 0.645 15    1.980     5.45   5.765  0.0001\n\nConfidence level used: 0.95 \nConf-level adjustment: bonferroni method for 3 estimates \nP value adjustment: holm method for 3 tests \n```\n:::\n:::\n\n\nP値は低い値から高い値へ並べ替えてから、$p_{adj} = (m+1-k)\\times p$ によって求めます。\n$m$ は比較の数、 $k$ は比較の指数です。\n\n\n::: {.callout-note}\nボンフェロニ法とホルム=ボンフェロニ法の\nP値は次のように求められます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemout = emmeans(fullmodel, specs = pairwise ~ site, adjust = \"none\")\nx = emout$contrasts  |>  as_tibble()\nx  |>  arrange(p.value)  |> \n  mutate(k = 1:3)  |> mutate(m = n())  |> \n  mutate(p.bonferroni = p.value * m,\n         p.holm = p.value * (m + 1 - k))  |> \n  select(contrast, m, k, starts_with(\"p\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 6\n  contrast     m     k   p.value p.bonferroni   p.holm\n  <chr>    <int> <int>     <dbl>        <dbl>    <dbl>\n1 B - C        3     1 0.0000373     0.000112 0.000112\n2 A - B        3     2 0.00366       0.0110   0.00731 \n3 A - C        3     3 0.0344        0.103    0.0344  \n```\n:::\n:::\n\n:::\n\n## テューキーのHSD法\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemout = emmeans(fullmodel, specs = pairwise ~ site, data=dset, adjust = \"tukey\")\nemout$contrasts |> summary(infer =T)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate    SE df lower.CL upper.CL t.ratio p.value\n A - B       -2.22 0.645 15   -3.891   -0.542  -3.438  0.0096\n A - C        1.50 0.645 15   -0.174    3.174   2.327  0.0826\n B - C        3.72 0.645 15    2.042    5.391   5.765  0.0001\n\nConfidence level used: 0.95 \nConf-level adjustment: tukey method for comparing a family of 3 estimates \nP value adjustment: tukey method for comparing a family of 3 estimates \n```\n:::\n:::\n\n\nP値はステュデント化範囲の分布^[Studentized range distribution]に従います。\n\n\n## シェッフェの方法\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemout = emmeans(fullmodel, specs = pairwise ~ site, data=dset, adjust = \"scheffe\")\nemout$contrasts |> summary(infer =T)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate    SE df lower.CL upper.CL t.ratio p.value\n A - B       -2.22 0.645 15   -3.966   -0.467  -3.438  0.0128\n A - C        1.50 0.645 15   -0.249    3.249   2.327  0.0991\n B - C        3.72 0.645 15    1.967    5.466   5.765  0.0002\n\nConfidence level used: 0.95 \nConf-level adjustment: scheffe method with rank 2 \nP value adjustment: scheffe method with rank 2 \n```\n:::\n:::\n\n\nP値はF分布に従います。\n\n## ダネットの検定\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemout = emmeans(fullmodel, specs = trt.vs.ctrl ~ site, ref = 2)\nemout$contrasts |> summary(infer =T)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast estimate    SE df lower.CL upper.CL t.ratio p.value\n A - B       -2.22 0.645 15     -3.8   -0.633  -3.438  0.0070\n C - B       -3.72 0.645 15     -5.3   -2.133  -5.765  0.0001\n\nConfidence level used: 0.95 \nConf-level adjustment: dunnettx method for 2 estimates \nP value adjustment: dunnettx method for 2 tests \n```\n:::\n:::\n\n\nダネットの検定は、各水準は標準水準と比較する方法です。\nP値は多変量 t 分布に従います。\n\n\n## 多重比較のおすすめ\n\n* 比較: A -- B, A -- C, B -- C <i class=\"bi bi-arrow-right\"></i> **テューキーのHSD法**\n* 比較: A -- B, A -- C, A -- D <i class=\"bi bi-arrow-right\"></i> **ダネット法**\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}